name: Enforce Breaking-Change Answers

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read   # read-only; no writes

jobs:
  enforce:
    name: "Breaking-change answers"
    runs-on: ubuntu-latest
    steps:
      - name: Check COLMAP question (exactly one answer)
        env:
          BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "üîç Checking breaking changes checklist‚Ä¶"

          HEADER="### Does this PR introduce breaking changes to **colmap/pycolmap public APIs**?"

          if ! grep -Fq "$HEADER" <<< "$BODY"; then
            echo "::error title=Missing question::Missing line: $HEADER"
            exit 1
          fi

          # Get lines after the header (the two checkboxes)
          LINES="$(awk -v header="$HEADER" '
            $0 == header {found=1; next}
            found {print}
          ' <<< "$BODY" | head -n 5)"

          # Count checked boxes
          YES=$(grep -iE '^\s*>?\s*-\s*\[[xX]\]\s*Yes' <<< "$LINES" | wc -l | tr -d ' ')
          NO=$( grep -iE '^\s*>?\s*-\s*\[[xX]\]\s*No'  <<< "$LINES" | wc -l | tr -d ' ')
          TOTAL=$((YES + NO))

          echo "Found: YES=$YES NO=$NO"
          if [ "$TOTAL" -ne 1 ]; then
            echo "::error title=Exactly one required::Tick exactly one (Yes or No)."
            exit 1
          fi

          echo "‚úÖ Breaking changes answer OK."

      - name: Summary
        if: ${{ success() }}
        run: |
          echo "Both breaking-change questions answered correctly."

