name: Enforce Breaking-Change Answers

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read   # read-only; no writes

jobs:
  enforce:
    name: "Breaking-change answers"
    runs-on: ubuntu-latest
    steps:
      - name: Check COLMAP question (exactly one answer)
        env:
          BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "üîç Checking COLMAP‚Ä¶"

          LABEL="### 1) Does this PR introduce breaking changes to **COLMAP public APIs**?"
          if ! grep -Fq "$LABEL" <<< "$BODY"; then
            echo "::error title=Missing section::Include the COLMAP section: $LABEL"
            exit 1
          fi

          # Extract the block under the COLMAP section until the next '### ' header.
          BLOCK="$(awk -v header="$LABEL" '
            BEGIN{p=0}
            index($0, header){p=1; next}
            /^### / && p==1{exit}
            p==1{print}
          ' <<< "$BODY")"

          if [ -z "$BLOCK" ]; then
            echo "::error title=Missing options::No checkbox block found under COLMAP section."
            exit 1
          fi

          # ‚úÖ Require exactly one answer (Yes or No, not both)
          # Matches any '- [x]' or '- [X]' line beginning with Yes/No (case-insensitive)
          # Ignores extra punctuation or trailing text (like '‚Äî this PR breaks...')
          YES=$(printf "%s\n" "$BLOCK" | grep -iE '^[[:space:]]*>[[:space:]]*-[[:space:]]*\[[xX]\][[:space:]]*Yes\b' | wc -l | tr -d ' ')
          NO=$( printf "%s\n" "$BLOCK" | grep -iE '^[[:space:]]*>[[:space:]]*-[[:space:]]*\[[xX]\][[:space:]]*No\b'  | wc -l | tr -d ' ' )
          TOTAL=$((YES + NO))

          echo "Found COLMAP: YES=$YES NO=$NO"
          if [ "$TOTAL" -ne 1  ]; then
            echo "::error title=Exactly one required::Tick exactly one for COLMAP (Yes or No)."
            exit 1
          fi

          echo "‚úÖ COLMAP answer OK."

      - name: Check pycolmap question (exactly one answer)
        env:
          BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "üîç Checking pycolmap‚Ä¶"

          LABEL="### 2) Does this PR introduce breaking changes to **pycolmap public APIs**?"
          if ! grep -Fq "$LABEL" <<< "$BODY"; then
            echo "::error title=Missing section::Include the pycolmap section: $LABEL"
            exit 1
          fi

          # Extract the block under the pycolmap section until the next '### ' header.
          BLOCK="$(awk -v header="$LABEL" '
            BEGIN{p=0}
            index($0, header){p=1; next}
            /^### / && p==1{exit}
            p==1{print}
          ' <<< "$BODY")"

          if [ -z "$BLOCK" ]; then
            echo "::error title=Missing options::No checkbox block found under pycolmap section."
            exit 1
          fi

          # ‚úÖ Require exactly one answer (Yes or No, not both)
          YES=$(printf "%s\n" "$BLOCK" | grep -iE '^[[:space:]]*>[[:space:]]*-[[:space:]]*\[[xX]\][[:space:]]*Yes\b' | wc -l | tr -d ' ')
          NO=$( printf "%s\n" "$BLOCK" | grep -iE '^[[:space:]]*>[[:space:]]*-[[:space:]]*\[[xX]\][[:space:]]*No\b'  | wc -l | tr -d ' ' )
          TOTAL=$((YES + NO))

          echo "Found pycolmap: YES=$YES NO=$NO"
          if [ "$TOTAL" -ne 1  ]; then
            echo "::error title=Exactly one required::Tick exactly one for pycolmap (Yes or No)."
            exit 1
          fi

          echo "‚úÖ pycolmap answer OK."

      - name: Summary
        if: ${{ success() }}
        run: |
          echo "Both breaking-change questions answered correctly."

