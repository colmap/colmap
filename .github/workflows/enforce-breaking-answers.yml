name: Enforce Breaking-Change Answers

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: write   # needed for labeling
  contents: read

jobs:
  enforce:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR body for breaking-change answers
        env:
          BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "üîç Validating PR body..."

          # ------------------------------------------------------------------------------
          # This workflow enforces that:
          # 1. Both COLMAP and pycolmap breaking-change questions exist in the PR body.
          # 2. Each question has exactly ONE answer checked (either "Yes" OR "No", not both).
          # ------------------------------------------------------------------------------

          required_sections=("### 1) Does this PR introduce breaking changes to **COLMAP public APIs**?"
                             "### 2) Does this PR introduce breaking changes to **pycolmap public APIs**?")

          # Ensure both section headers are present
          for section in "${required_sections[@]}"; do
            if ! grep -Fq "$section" <<< "$BODY"; then
              echo "::error title=Missing section::The PR body must include the section: $section"
              echo "Please use the repository's PR template."
              exit 1
            fi
          done

          # ------------------------------------------------------------------------------
          # Helper function: ensure each question has exactly one checkbox selected
          # ------------------------------------------------------------------------------
          check_answer () {
            local label="$1"
            local yes_pattern="$2"
            local no_pattern="$3"

            # Extract the section block for the question
            BLOCK="$(awk -v header="$label" '
              BEGIN{p=0}
              index($0, header){p=1; next}
              /^### / && p==1{exit}
              p==1{print}
            ' <<< "$BODY")"

            if [ -z "$BLOCK" ]; then
              echo "::error title=Missing options::No checkbox block found under: $label"
              exit 1
            fi

            # ‚úÖ Require exactly one answer per question (Yes or No, not both)
            YES_COUNT=$(grep -iE "^- \[x\] $yes_pattern" <<< "$BLOCK" | wc -l | tr -d ' ')
            NO_COUNT=$(grep -iE "^- \[x\] $no_pattern" <<< "$BLOCK" | wc -l | tr -d ' ')
            TOTAL=$((YES_COUNT + NO_COUNT))

            if [ "$TOTAL" -ne 1 ]; then
              echo "::error title=Exactly one selection required::$label ‚Äî tick exactly one option (Yes or No)."
              exit 1
            fi
          }

          check_answer \
            "### 1) Does this PR introduce breaking changes to **COLMAP public APIs**?" \
            "Yes ‚Äî this PR breaks COLMAP APIs\." \
            "No ‚Äî no breaking changes to COLMAP APIs\."

          check_answer \
            "### 2) Does this PR introduce breaking changes to **pycolmap public APIs**?" \
            "Yes ‚Äî this PR breaks pycolmap APIs\." \
            "No ‚Äî no breaking changes to pycolmap APIs\."

          echo "‚úÖ PR body looks good."

      # --- Auto-label based on answers ---

      - name: Add generic breaking label
        if: >
          contains(github.event.pull_request.body, 'Yes ‚Äî this PR breaks COLMAP APIs.') ||
          contains(github.event.pull_request.body, 'Yes ‚Äî this PR breaks pycolmap APIs.')
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: breaking

      - name: Remove generic breaking label if no breaking changes
        if: >
          contains(github.event.pull_request.body, 'No ‚Äî no breaking changes to COLMAP APIs.') &&
          contains(github.event.pull_request.body, 'No ‚Äî no breaking changes to pycolmap APIs.')
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          labels: breaking

      - name: Add scoped breaking:colmap label
        if: contains(github.event.pull_request.body, 'Yes ‚Äî this PR breaks COLMAP APIs.')
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: breaking:colmap

      - name: Add scoped breaking:pycolmap label
        if: contains(github.event.pull_request.body, 'Yes ‚Äî this PR breaks pycolmap APIs.')
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: breaking:pycolmap

      - name: Remove scoped labels when both are No
        if: >
          contains(github.event.pull_request.body, 'No ‚Äî no breaking changes to COLMAP APIs.') &&
          contains(github.event.pull_request.body, 'No ‚Äî no breaking changes to pycolmap APIs.')
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          labels: |
            breaking:colmap
            breaking:pycolmap

