name: Sync Breaking Scope Labels

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  issues: write   # needed to add/remove labels via Issues API

jobs:
  sync_labels:
    runs-on: ubuntu-latest
    steps:
      - name: Derive desired labels from PR body and sync
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            // Fetch the latest PR body
            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: issue_number });
            const body = (pr.body || "").toLowerCase();

            // Helper: extract section text after a heading (robust to spacing/case)
            function sectionAfter(headingPattern) {
              const re = new RegExp(headingPattern, 'i');
              const m = body.match(re);
              if (!m) return "";
              const rest = body.slice(m.index + m[0].length);
              const next = /(^|\n)###\s+/i.exec(rest);
              return next ? rest.slice(0, next.index) : rest;
            }

            // Your headings (tolerant regex)
            const hColmap = String.raw`###\s*1\)\s*does this pr introduce breaking changes to\s*\*\*colmap public apis\*\*\s*\?`;
            const hPy     = String.raw`###\s*2\)\s*does this pr introduce breaking changes to\s*\*\*pycolmap public apis\*\*\s*\?`;

            const colmapBlock = sectionAfter(hColmap);
            const pyBlock     = sectionAfter(hPy);

            // Template uses '> - [x] No/Yes ...'
            const CHECK_YES = />\s*-\s*\[(x)\]\s*yes\b/i;

            const yesColmap = CHECK_YES.test(colmapBlock);
            const yesPy     = CHECK_YES.test(pyBlock);

            // Desired labels (scoped only)
            const desired = new Set();
            if (yesColmap) desired.add('breaking:colmap');
            if (yesPy)     desired.add('breaking:pycolmap');

            // Current labels
            const { data: current } = await github.rest.issues.listLabelsOnIssue({
              owner, repo, issue_number, per_page: 100
            });
            const currentNames = new Set(current.map(l => l.name));

            // Only manage these two; leave other labels untouched
            const managed  = new Set(['breaking:colmap', 'breaking:pycolmap']);
            const toAdd    = [...desired].filter(l => !currentNames.has(l));
            const toRemove = [...currentNames].filter(l => managed.has(l) && !desired.has(l));

            core.startGroup('Label sync debug');
            core.info(`Detected: COLMAP yes=${yesColmap} | pycolmap yes=${yesPy}`);
            core.info(`Current:  ${[...currentNames].join(', ') || '(none)'}`);
            core.info(`Desired:  ${[...desired].join(', ') || '(none)'}`);
            core.info(`Add:      ${toAdd.join(', ') || '(none)'} | Remove: ${toRemove.join(', ') || '(none)'}`);
            core.endGroup();

            if (toAdd.length) {
              await github.rest.issues.addLabels({ owner, repo, issue_number, labels: toAdd });
            }
            for (const name of toRemove) {
              await github.rest.issues.removeLabel({ owner, repo, issue_number, name }).catch(() => {});
            }

      - name: Summary
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number, per_page: 100 });
            core.summary.addHeading('Label sync result', 2)
                        .addList(labels.map(l => l.name))
                        .write()

